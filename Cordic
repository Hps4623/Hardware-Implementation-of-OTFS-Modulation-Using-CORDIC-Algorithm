module cordic(
    input clock,
    input signed [15:0] xstart,
    input signed [15:0] ystart,
    input signed [31:0] zangle,
    output signed [15:0] xout,
    output signed [15:0] yout,
    output reg done
    );

reg znext;

wire signed [63:0] atan_table[0:63];


assign atan_table[00] = 'b0010000000000000000000000000000000000000000000000000000000000000; // 45.000 degrees -> atan(2^0)
assign atan_table[01] = 'b0001001011100100000001010001110110011101111100110000100100000000; // 26.565 degrees -> atan(2^-1)
assign atan_table[02] = 'b0000100111111011001110000101101101011110111000111001111010000000; // 14.036 degrees -> atan(2^-2)
assign atan_table[03] = 'b0000010100010001000100011101010000011101110111011001101001000000; // atan(2^-3)
assign atan_table[04] = 'b0000001010001011000011010100001100001110010110001001101011100000;
assign atan_table[05] = 'b0000000101000101110101111110000101011001000001000110001010000000;
assign atan_table[06] = 'b0000000010100010111101100001111001011100001010000010011000110000;
assign atan_table[07] = 'b0000000001010001011111000101010100010001110101000100001010110000;
assign atan_table[08] = 'b0000000000101000101111100101001101000110110100001100001100111000;
assign atan_table[09] = 'b0000000000010100010111110010111010111011001100001010101100111000;
assign atan_table[10] = 'b0000000000001010001011111001100000000000100100011011101001111011;
assign atan_table[11] = 'b0000000000000101000101111100110000010100101010000000110010110111;
assign atan_table[12] = 'b0000000000000010100010111110011000001100110111111110110001100001;
assign atan_table[13] = 'b0000000000000001010001011111001100000110110000010111001011110010;
assign atan_table[14] = 'b0000000000000000101000101111100110000011011010101110100100010001;
assign atan_table[15] = 'b0000000000000000010100010111110011000001101101101011101001111011;
assign atan_table[16] = 'b0000000000000000000000101000101111100110000011011011100100111000;
assign atan_table[17] = 'b0000000000000000001010001011111001100000110110111000010111111100; 
assign atan_table[18] = 'b0000000000000000000101000101111100110000011011011100100000010101;
assign atan_table[19] = 'b0000000000000000000010100010111110011000001101101110010010101101; 
assign atan_table[20] = 'b0000000000000000000001010001011111001100000110110111001001101011; 
assign atan_table[21] = 'b0000000000000000000000101000101111100110000011011011100100111000;
assign atan_table[22] = 'b0000000000000000000000010100010111110011000001101101110010011100;
assign atan_table[23] = 'b0000000000000000000000001010001011111001100000110110111001001110;
assign atan_table[24] = 'b0000000000000000000000000101000101111100110000011011011100100111;
assign atan_table[25] = 'b0000000000000000000000000010100010111110011000001101101110010011;
assign atan_table[26] = 'b0000000000000000000000000001010001011111001100000110110111001001;
assign atan_table[27] = 'b0000000000000000000000000000101000101111100110000011011011100100;
assign atan_table[28] = 'b0000000000000000000000000000010100010111110011000001101101110010;
assign atan_table[29] = 'b0000000000000000000000000000001010001011111001100000110110111001;
assign atan_table[30] = 'b0000000000000000000000000000000101000101111100110000011011011100;
assign atan_table[31] = 'b0000000000000000000000000000000010100010111110011000001101101110;
assign atan_table[32] = 'b0000000000000000000000000000000001010001011111001100000110110111;
assign atan_table[33] = 'b0000000000000000000000000000000000101000101111100110000011011011; 
assign atan_table[34] = 'b0000000000000000000000000000000000010100010111110011000001101101; 
assign atan_table[35] = 'b0000000000000000000000000000000000001010001011111001100000110110;
assign atan_table[36] = 'b0000000000000000000000000000000000000101000101111100110000011011; 
assign atan_table[37] = 'b0000000000000000000000000000000000000001010001011111001100000110;
assign atan_table[38] = 'b0000000000000000000000000000000000000000101000101111100110000011;
assign atan_table[39] = 'b0000000000000000000000000000000000000000010100010111110011000001;
assign atan_table[40] = 'b0000000000000000000000000000000000000000001010001011111001100000;
assign atan_table[41] = 'b0000000000000000000000000000000000000000000101000101111100110000;
assign atan_table[42] = 'b0000000000000000000000000000000000000000000010100010111110011000;
assign atan_table[43] = 'b0000000000000000000000000000000000000000000001010001011111001100;
assign atan_table[44] = 'b0000000000000000000000000000000000000000000000101000101111100110;
assign atan_table[45] = 'b0000000000000000000000000000000000000000000000010100010111110011;
assign atan_table[46] = 'b0000000000000000000000000000000000000000000000001010001011111001;
assign atan_table[47] = 'b0000000000000000000000000000000000000000000000000101000101111100;
assign atan_table[48] = 'b0000000000000000000000000000000000000000000000000010100010111110;
assign atan_table[49] = 'b0000000000000000000000000000000000000000000000000001010001011111; 
assign atan_table[50] = 'b0000000000000000000000000000000000000000000000000000101000101111; 
assign atan_table[51] = 'b0000000000000000000000000000000000000000000000000000010100010111; 
assign atan_table[52] = 'b0000000000000000000000000000000000000000000000000000001010001011;
assign atan_table[53] = 'b0000000000000000000000000000000000000000000000000000000101000101;
assign atan_table[54] = 'b0000000000000000000000000000000000000000000000000000000010100010;
assign atan_table[55] = 'b0000000000000000000000000000000000000000000000000000000001010001;
assign atan_table[56] = 'b0000000000000000000000000000000000000000000000000000000000101000;
assign atan_table[57] = 'b0000000000000000000000000000000000000000000000000000000000010100;
assign atan_table[58] = 'b0000000000000000000000000000000000000000000000000000000000001010;
assign atan_table[59] = 'b0000000000000000000000000000000000000000000000000000000000000101;
assign atan_table[60] = 'b0000000000000000000000000000000000000000000000000000000000000010;
assign atan_table[61] = 'b0000000000000000000000000000000000000000000000000000000000000001;
assign atan_table[62] = 'b0000000000000000000000000000000000000000000000000000000000000000;
assign atan_table[63] = 'b0000000000000000000000000000000000000000000000000000000000000000;



parameter width = 16;

reg signed [15:0] xcomp_start,ycomp_start;
reg [3:0] out = 4'b0000;

wire [1:0] quad;
assign quad = zangle[31:30];

reg signed [width:0] x [0:width-1];
reg signed [width:0] y [0:width-1];
reg signed [31:0] z [0:width-1]; // col z[rows]


always @(posedge clock)
begin

xcomp_start = (xstart>>>1)+(xstart>>>4)+(xstart>>>5)+(xstart>>>6)-(xstart>>>9);      //approximation of gain factor to 0.607
ycomp_start = (ystart>>>1)+(ystart>>>4)+(ystart>>>5)+(ystart>>>6)-(ystart>>>9);

case(quad)
	2'b00,2'b11:
		begin		// -90 to 90
		x[0] <= xcomp_start;
		y[0] <= ycomp_start;
		z[0] <= zangle;
		end
	2'b01:				//subtract 90	(second quadrant)
		begin
		x[0] <= -ycomp_start;
		y[0] <= xcomp_start;
		z[0] <= {2'b00,zangle[29:0]};
		end
	2'b10:				// add 90 (third quadrant)
		begin
		x[0] <= ycomp_start;			
		y[0] <= -xcomp_start;
		z[0] <= {2'b11,zangle[29:0]};
		end
		
endcase
end


genvar i;
generate
for (i=0;i<15;i=i+1)
begin: iterations

	wire signed [width:0] xshift, yshift;

	assign xshift = x[i] >>> i; // signed shift right
	assign yshift = y[i] >>> i;

	always @(posedge clock)
		begin
		x[i+1] <= z[i][31] ? x[i]+ yshift:x[i]-yshift;
		y[i+1] <= z[i][31] ? y[i]-xshift:y[i]+xshift;
		z[i+1] <= z[i][31] ? z[i]+atan_table[i]:z[i]-atan_table[i];
        out <= out+1;
        if (out == 4'b1111)
        done = 'b1;
        else
        done = 'b0;

	end


end
endgenerate



assign xout = x[width-1];
assign yout = y[width-1];

endmodule
